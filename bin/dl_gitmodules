#!/bin/bash

function is_git_repo () {
    [[ -d "${PWD}"/.git ]] || git rev-parse --git-dir &>/dev/null
}

gitmodules_file="${PWD}"/.gitmodules

if ! is_git_repo; then
    echo "${PWD} is not a git repository" 1>&2
    exit 2
fi

if ! [[ -f "${gitmodules_file}" ]]; then
    echo "${gitmodules_file} does not exist" 2>&2
    exit 2
fi

while read path_key path; do
    url_key="$(sed 's/\.path/.url/g' <<<"${path_key}")"
    url="$(git config -f "${gitmodules_file}" --get "${url_key}")"
    git submodule add "${url}" "${path}"
done < <(git config -f "${gitmodules_file}" --get-regexp '^submodule\..*\.path$')
